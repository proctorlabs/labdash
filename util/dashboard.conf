# Use this config with docker-compose in dev environment to test with running service
lua_code_cache off;
resolver 8.8.8.8;
proxy_cache_path  /tmp/img levels=1:2 keys_zone=img_cache:10m inactive=24h max_size=1g use_temp_path=off;
proxy_cache_path  /tmp/red levels=1:2 keys_zone=rd_cache:10m inactive=24h max_size=1g use_temp_path=off;

server {
    listen 80 default_server;
    access_log off;

    location /images/random {
        proxy_pass 'https://source.unsplash.com/random';
        proxy_intercept_errors on;
        error_page 302 = @handle_redirect;
    }

    location @handle_redirect {
        proxy_intercept_errors on;
        set $saved_redirect_location '$upstream_http_location';
        proxy_pass $saved_redirect_location;
        proxy_buffering        on;
        proxy_ignore_headers   X-Accel-Expires Expires Cache-Control;
        proxy_cache            img_cache;
        proxy_cache_valid      any 30m;
        proxy_cache_use_stale  error timeout invalid_header updating http_500 http_502 http_503 http_504;
    }

    location / {
        proxy_pass http://vue.server:8080;
        proxy_set_header Host 'localhost:8080';
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Location $request_uri;
    }

    location /api/ {
        content_by_lua_file 'api.lua';
    }

    location /authcheck/ {
        access_by_lua_file 'authorize.lua';
        return 302 /;
    }
}
